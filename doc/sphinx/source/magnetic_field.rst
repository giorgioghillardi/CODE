
.. _magnetic-fields:

Magnetic fields
===============

*To learn about how magnetic fields are configured in SOFT, check out*
:ref:`module-magneticfield`.

Magnetic fields in SOFT come in two flavours: analytical and numerical. The
former allows the user to specify common properties of the magnetic field,
such as its on-axis strength and major radius, and generates a corresponding
magnetic field with circular flux surfaces. The latter takes a numerical
representation of a 2D magnetic field as input, and permits more complicated
magnetic equilibria.

Analytical magnetic field
-------------------------
The analytical magnetic field in SOFT is defined as

.. math::

   B(r,\theta) = \frac{B_0 R_{\rm m}}{R_{\rm m} - r\cos\theta}\left( \frac{r}{q(r)R_{\rm m}} \hat{\boldsymbol{\theta}} + \sigma_B\hat{\boldsymbol{\varphi}} \right).

Here, :math:`r` denotes minor radius, :math:`\theta` denotes poloidal angle, and
:math:`\hat{\boldsymbol{\theta}}` and :math:`\hat{\boldsymbol{\varphi}}` are
unit vectors in the poloidal and toroidal directions respectively. The
parameters of the magnetic field that must be specified by the user are the
on-axis field strength :math:`B_0`, the major radius :math:`R_{\rm m}`, the
safety factor :math:`q(r)` and the toroidal field sign :math:`\sigma_B`.

The radial profile of the safety factor can take four different forms in SOFT:

.. math::

   q_{\rm const}(a) &= q_{a1},

   q_{\rm lin}(a)   &= q_{a1} a + q_{a2},

   q_{\rm quad}(a)  &= q_{a1} a^2 + q_{a2},

   q_{\rm exp}(a)   &= e^{q_{a1} a} + q_{a2},

where :math:`a` is the minor radius, normalized to the minor radius at the
last closed flux surface, and :math:`q_{a1}` and :math:`q_{a2}` are constants
set by the user.

*More information about how to configure an analytical magnetic field can
be found at* :ref:`module-magneticfield`.


Numerical magnetic field
------------------------
A file defining a numerical magnetic field must contain tables of the radial,
vertical and toroidal magnetic field components, as well as wall contours and
some meta data. Using this information, SOFT interpolates in the magnetic
field data to evaluate its components in arbitrary points of space, and uses
the wall contours to block out radiation.

SOFT is able to load three different types of files: HDF5, MAT and SDT. The
former two can be generated by a wide range of tools and programming languages,
while the latter is a very simple text-based format developed specifically for
SOFT and designed to allow exporting data to at text file on systems with
limited access to more advanced libraries. Common to all these file formats
is that they allow us to store data in variables. SOFT therefore expects any
given input file to contain certain variables that provide the information
necessary to run a simulation The below table lists the variables that SOFT
look for in a magnetic field file.

**Variables of numerical magnetic field**

+-------------------------+----------------+------------------+------------------------------------+
| **Variable**            | **Mandatory**  | **Type**         | **Description**                    |
+-------------------------+----------------+------------------+------------------------------------+
| :option:`mf Bphi`       | **Yes**        | nz-by-nr matrix  | Toroidal field component           |
+-------------------------+----------------+------------------+------------------------------------+
| :option:`mf Br`         | **Yes**        | nz-by-nr matrix  | Radial field component             |
+-------------------------+----------------+------------------+------------------------------------+
| :option:`mf Bz`         | **Yes**        | nz-by-nr matrix  | Vertical field component           |
+-------------------------+----------------+------------------+------------------------------------+
| :option:`mf desc`       | **Yes**        | String           | (Meta) Description of data         |
+-------------------------+----------------+------------------+------------------------------------+
| :option:`mf maxis`      | **Yes**        | 2-vector         | Location of magnetic axis          |
+-------------------------+----------------+------------------+------------------------------------+
| :option:`mf name`       | **Yes**        | String           | (Meta) Name of magnetic field data |
+-------------------------+----------------+------------------+------------------------------------+
| :option:`mf r`          | **Yes**        | nr-vector        | Radial grid                        |
+-------------------------+----------------+------------------+------------------------------------+
| :option:`mf separatrix` | **Yes** [#sw]_ | 2-by-many vector | Last closed flux surface contour   |
+-------------------------+----------------+------------------+------------------------------------+
| :option:`mf verBphi`    | *No*           | nr-vector        | Verification array for ``Bphi``    |
+-------------------------+----------------+------------------+------------------------------------+
| :option:`mf verBr`      | *No*           | nr-vector        | Verification array for ``Br``      |
+-------------------------+----------------+------------------+------------------------------------+
| :option:`mf verBz`      | *No*           | nr-vector        | Verification array for ``Bz``      |
+-------------------------+----------------+------------------+------------------------------------+
| :option:`mf wall`       | **Yes** [#sw]_ | 2-by-many vector | Tokamak wall contour               |
+-------------------------+----------------+------------------+------------------------------------+
| :option:`mf z`          | **Yes**        | nz-vector        | Vertical grid                      |
+-------------------------+----------------+------------------+------------------------------------+

*Beware that some tools handle data in column-major format, whereas SOFT uses column-major format.
You may therefore have to transpose certain data to have the correct shape. The vectors ``verXXX``
can be used to ensure that the magnetic field components have the proper format.*

.. [#sw] At least one of the separatrix and wall variables must be present in the file.

Parameter details
*****************

.. program:: mf

.. option:: Bphi

.. option:: Br

.. option:: Bz

   :Shape: nz-by-nr
   :Mandatory: **Yes**

   Magnetic field components in an :math:`RZ` plane. These are given
   as matrices with :math:`n_z`-by-:math:`n_r` points (i.e. :math:`n_z` rows
   and :math:`n_r` columns), where element :math:`ij` corresponds to height
   :math:`i` on the vertical grid :option:`mf z` and radius :math:`j` on the
   radial grid :option:`mf r`.

   Components are given in units of Tesla.

.. option:: desc

.. option:: name

   :Type: Strings
   :Mandatory: **Yes**

   These variables contain meta information about the magnetic field data. While
   they must be present in the file, there are not requirements on their format.
   They should be used to keep track of what datasets magnetic field fiels come 
   from.

.. option:: maxis

   :Shape: 2-by-1
   :Mandatory: **Yes**

   Radial and vertical coordinates of the magnetic axis: :math:`(R_{\rm axis}, Z_{\rm axis})`.

.. option:: r

   :Shape: nr-by-1
   :Mandatory: **Yes**

.. option:: z

   :Shape: nz-by-1
   :Mandatory: **Yes**

   Vectors that define the grid on which the magnetic field components are
   given. The whole grid must be a valid meshgrid, and this enforced by
   demanding it to be specified in terms of these grid vectors instead.

   The magnetic field components are evaluated on this grid, so that component
   :math:`x` of the magnetic field is

   .. math::

      B_{ij} = B_x\left( r_j, z_i \right),

   where :math:`i` is the row index and :math:`j` is the column index and

.. option:: separatrix

.. option:: wall

   :Shape: 2-by-many
   :Mandatory: At least one of ``separatrix`` and ``wall``

   Contains the contour line for the separatrix/wall. The first row contains
   the :math:`R`-coordinates of the contour and the second row contains the
   :math:`Z`-coordinates.

   At least one of these must be provided in the magnetic field file. If only
   one of them is provided, that contour is used both as wall and separatrix.
   If both are present, SOFT uses the wall to filter out radiation that comes
   from behind a wall and verify that particles do not collide with the walls.
   The separatrix is used to define the normalized minor radius.

.. option:: verBphi

.. option:: verBr

.. option:: verBz

   :Shape: nr-by-1 vector
   :Mandatory: *No*

   These vectors can be used to verify that the magnetic field components have
   the correct format. Since Matlab tends to be inconsistent with whether a
   matrix is stored in row-major or column-major form, these vectors can be
   used to ensure that SOFT reads the magnetic field components with a radial
   dependence along the column index, and vertical dependence along the row
   index.
   
   These vectors may have *at most* as many elements as the number of columns
   in the magnetic field matrices. There may be fewer elements.

